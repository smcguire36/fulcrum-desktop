'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _task = require('./task');

var _task2 = _interopRequireDefault(_task);

var _fulcrumCore = require('fulcrum-core');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { return Promise.resolve(value).then(function (value) { step("next", value); }, function (err) { step("throw", err); }); } } return step("next"); }); }; }

const PAGE_SIZE = 500;

class DownloadResource extends _task2.default {
  get syncResourceName() {
    return this.resourceName;
  }

  get pageSize() {
    return PAGE_SIZE;
  }

  get syncResourceScope() {
    return null;
  }

  get resourceName() {
    throw new Error('must implement resourceName');
  }

  get typeName() {
    throw new Error('must implement typeName');
  }

  get propertyName() {
    return this.typeName;
  }

  get syncLabel() {
    return this.resourceName.replace('_', ' ');
  }

  fetchObjects(lastSync, sequence) {
    throw new Error('must implement fetchObjects');
  }

  fetchLocalObjects() {
    throw new Error('must implement fetchLocalObjects');
  }

  findOrCreate(database, attributes) {
    throw new Error('must implement findOrCreate');
  }

  loadObject(object, attributes) {}

  process(object, attributes) {
    var _this = this;

    return _asyncToGenerator(function* () {
      const isChanged = !object.isPersisted || _fulcrumCore.DateUtils.parseISOTimestamp(attributes.updated_at).getTime() !== object.updatedAt.getTime();

      object.updateFromAPIAttributes(attributes);

      if (object._deletedAt != null) {
        object._deletedAt = null;
      }

      yield _this.loadObject(object, attributes);

      yield object.save();

      if (isChanged) {
        yield _this.triggerEvent('save', { [_this.propertyName]: object });
      }
    })();
  }

  triggerEvent(name, args) {
    return this.trigger(`${this.typeName}:${name}`, args);
  }

  fail(account, results) {
    console.log(account.organizationName.green, 'failed'.red);
  }

  run({ dataSource }) {
    var _this2 = this;

    return _asyncToGenerator(function* () {
      const sync = yield _this2.checkSyncState();

      if (!sync.needsUpdate) {
        return;
      }

      _this2.progress({ message: _this2.downloading + ' ' + _this2.syncLabel });

      const response = yield _this2.fetchObjects();

      const objects = JSON.parse(response.body)[_this2.resourceName];

      _this2.progress({ message: _this2.processing + ' ' + _this2.syncLabel, count: 0, total: objects.length });

      const localObjects = yield _this2.fetchLocalObjects();

      _this2.markDeletedObjects(localObjects, objects, _this2.typeName, _this2.propertyName);

      for (let index = 0; index < objects.length; ++index) {
        const attributes = objects[index];

        const object = yield _this2.findOrCreate(_this2.account.db, attributes);

        yield _this2.process(object, attributes);

        _this2.progress({ message: _this2.processing + ' ' + _this2.syncLabel, count: index + 1, total: objects.length });
      }

      yield sync.update();

      dataSource.source.invalidate(_this2.resourceName);

      _this2.progress({ message: _this2.finished + ' ' + _this2.syncLabel, count: objects.length, total: objects.length });
    })();
  }
}
exports.default = DownloadResource;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9tYWluL3N5bmMvdGFza3MvZG93bmxvYWQtcmVzb3VyY2UuanMiXSwibmFtZXMiOlsiUEFHRV9TSVpFIiwiRG93bmxvYWRSZXNvdXJjZSIsInN5bmNSZXNvdXJjZU5hbWUiLCJyZXNvdXJjZU5hbWUiLCJwYWdlU2l6ZSIsInN5bmNSZXNvdXJjZVNjb3BlIiwiRXJyb3IiLCJ0eXBlTmFtZSIsInByb3BlcnR5TmFtZSIsInN5bmNMYWJlbCIsInJlcGxhY2UiLCJmZXRjaE9iamVjdHMiLCJsYXN0U3luYyIsInNlcXVlbmNlIiwiZmV0Y2hMb2NhbE9iamVjdHMiLCJmaW5kT3JDcmVhdGUiLCJkYXRhYmFzZSIsImF0dHJpYnV0ZXMiLCJsb2FkT2JqZWN0Iiwib2JqZWN0IiwicHJvY2VzcyIsImlzQ2hhbmdlZCIsImlzUGVyc2lzdGVkIiwicGFyc2VJU09UaW1lc3RhbXAiLCJ1cGRhdGVkX2F0IiwiZ2V0VGltZSIsInVwZGF0ZWRBdCIsInVwZGF0ZUZyb21BUElBdHRyaWJ1dGVzIiwiX2RlbGV0ZWRBdCIsInNhdmUiLCJ0cmlnZ2VyRXZlbnQiLCJuYW1lIiwiYXJncyIsInRyaWdnZXIiLCJmYWlsIiwiYWNjb3VudCIsInJlc3VsdHMiLCJjb25zb2xlIiwibG9nIiwib3JnYW5pemF0aW9uTmFtZSIsImdyZWVuIiwicmVkIiwicnVuIiwiZGF0YVNvdXJjZSIsInN5bmMiLCJjaGVja1N5bmNTdGF0ZSIsIm5lZWRzVXBkYXRlIiwicHJvZ3Jlc3MiLCJtZXNzYWdlIiwiZG93bmxvYWRpbmciLCJyZXNwb25zZSIsIm9iamVjdHMiLCJKU09OIiwicGFyc2UiLCJib2R5IiwicHJvY2Vzc2luZyIsImNvdW50IiwidG90YWwiLCJsZW5ndGgiLCJsb2NhbE9iamVjdHMiLCJtYXJrRGVsZXRlZE9iamVjdHMiLCJpbmRleCIsImRiIiwidXBkYXRlIiwic291cmNlIiwiaW52YWxpZGF0ZSIsImZpbmlzaGVkIl0sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQTs7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dGVudCI6WyJpbXBvcnQgVGFzayBmcm9tICcuL3Rhc2snO1xyXG5pbXBvcnQgeyBEYXRlVXRpbHMgfSBmcm9tICdmdWxjcnVtLWNvcmUnO1xyXG5cclxuY29uc3QgUEFHRV9TSVpFID0gNTAwO1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRG93bmxvYWRSZXNvdXJjZSBleHRlbmRzIFRhc2sge1xyXG4gIGdldCBzeW5jUmVzb3VyY2VOYW1lKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzb3VyY2VOYW1lO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHBhZ2VTaXplKCkge1xyXG4gICAgcmV0dXJuIFBBR0VfU0laRTtcclxuICB9XHJcblxyXG4gIGdldCBzeW5jUmVzb3VyY2VTY29wZSgpIHtcclxuICAgIHJldHVybiBudWxsO1xyXG4gIH1cclxuXHJcbiAgZ2V0IHJlc291cmNlTmFtZSgpIHtcclxuICAgIHRocm93IG5ldyBFcnJvcignbXVzdCBpbXBsZW1lbnQgcmVzb3VyY2VOYW1lJyk7XHJcbiAgfVxyXG5cclxuICBnZXQgdHlwZU5hbWUoKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ211c3QgaW1wbGVtZW50IHR5cGVOYW1lJyk7XHJcbiAgfVxyXG5cclxuICBnZXQgcHJvcGVydHlOYW1lKCkge1xyXG4gICAgcmV0dXJuIHRoaXMudHlwZU5hbWU7XHJcbiAgfVxyXG5cclxuICBnZXQgc3luY0xhYmVsKCkge1xyXG4gICAgcmV0dXJuIHRoaXMucmVzb3VyY2VOYW1lLnJlcGxhY2UoJ18nLCAnICcpO1xyXG4gIH1cclxuXHJcbiAgZmV0Y2hPYmplY3RzKGxhc3RTeW5jLCBzZXF1ZW5jZSkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCBmZXRjaE9iamVjdHMnKTtcclxuICB9XHJcblxyXG4gIGZldGNoTG9jYWxPYmplY3RzKCkge1xyXG4gICAgdGhyb3cgbmV3IEVycm9yKCdtdXN0IGltcGxlbWVudCBmZXRjaExvY2FsT2JqZWN0cycpO1xyXG4gIH1cclxuXHJcbiAgZmluZE9yQ3JlYXRlKGRhdGFiYXNlLCBhdHRyaWJ1dGVzKSB7XHJcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ211c3QgaW1wbGVtZW50IGZpbmRPckNyZWF0ZScpO1xyXG4gIH1cclxuXHJcbiAgbG9hZE9iamVjdChvYmplY3QsIGF0dHJpYnV0ZXMpIHtcclxuICB9XHJcblxyXG4gIGFzeW5jIHByb2Nlc3Mob2JqZWN0LCBhdHRyaWJ1dGVzKSB7XHJcbiAgICBjb25zdCBpc0NoYW5nZWQgPSAhb2JqZWN0LmlzUGVyc2lzdGVkIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICBEYXRlVXRpbHMucGFyc2VJU09UaW1lc3RhbXAoYXR0cmlidXRlcy51cGRhdGVkX2F0KS5nZXRUaW1lKCkgIT09IG9iamVjdC51cGRhdGVkQXQuZ2V0VGltZSgpO1xyXG5cclxuICAgIG9iamVjdC51cGRhdGVGcm9tQVBJQXR0cmlidXRlcyhhdHRyaWJ1dGVzKTtcclxuXHJcbiAgICBpZiAob2JqZWN0Ll9kZWxldGVkQXQgIT0gbnVsbCkge1xyXG4gICAgICBvYmplY3QuX2RlbGV0ZWRBdCA9IG51bGw7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgdGhpcy5sb2FkT2JqZWN0KG9iamVjdCwgYXR0cmlidXRlcyk7XHJcblxyXG4gICAgYXdhaXQgb2JqZWN0LnNhdmUoKTtcclxuXHJcbiAgICBpZiAoaXNDaGFuZ2VkKSB7XHJcbiAgICAgIGF3YWl0IHRoaXMudHJpZ2dlckV2ZW50KCdzYXZlJywge1t0aGlzLnByb3BlcnR5TmFtZV06IG9iamVjdH0pO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgdHJpZ2dlckV2ZW50KG5hbWUsIGFyZ3MpIHtcclxuICAgIHJldHVybiB0aGlzLnRyaWdnZXIoYCR7IHRoaXMudHlwZU5hbWUgfTokeyBuYW1lIH1gLCBhcmdzKTtcclxuICB9XHJcblxyXG4gIGZhaWwoYWNjb3VudCwgcmVzdWx0cykge1xyXG4gICAgY29uc29sZS5sb2coYWNjb3VudC5vcmdhbml6YXRpb25OYW1lLmdyZWVuLCAnZmFpbGVkJy5yZWQpO1xyXG4gIH1cclxuXHJcbiAgYXN5bmMgcnVuKHtkYXRhU291cmNlfSkge1xyXG4gICAgY29uc3Qgc3luYyA9IGF3YWl0IHRoaXMuY2hlY2tTeW5jU3RhdGUoKTtcclxuXHJcbiAgICBpZiAoIXN5bmMubmVlZHNVcGRhdGUpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZG93bmxvYWRpbmcgKyAnICcgKyB0aGlzLnN5bmNMYWJlbH0pO1xyXG5cclxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5mZXRjaE9iamVjdHMoKTtcclxuXHJcbiAgICBjb25zdCBvYmplY3RzID0gSlNPTi5wYXJzZShyZXNwb25zZS5ib2R5KVt0aGlzLnJlc291cmNlTmFtZV07XHJcblxyXG4gICAgdGhpcy5wcm9ncmVzcyh7bWVzc2FnZTogdGhpcy5wcm9jZXNzaW5nICsgJyAnICsgdGhpcy5zeW5jTGFiZWwsIGNvdW50OiAwLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcclxuXHJcbiAgICBjb25zdCBsb2NhbE9iamVjdHMgPSBhd2FpdCB0aGlzLmZldGNoTG9jYWxPYmplY3RzKCk7XHJcblxyXG4gICAgdGhpcy5tYXJrRGVsZXRlZE9iamVjdHMobG9jYWxPYmplY3RzLCBvYmplY3RzLCB0aGlzLnR5cGVOYW1lLCB0aGlzLnByb3BlcnR5TmFtZSk7XHJcblxyXG4gICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IG9iamVjdHMubGVuZ3RoOyArK2luZGV4KSB7XHJcbiAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBvYmplY3RzW2luZGV4XTtcclxuXHJcbiAgICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IHRoaXMuZmluZE9yQ3JlYXRlKHRoaXMuYWNjb3VudC5kYiwgYXR0cmlidXRlcyk7XHJcblxyXG4gICAgICBhd2FpdCB0aGlzLnByb2Nlc3Mob2JqZWN0LCBhdHRyaWJ1dGVzKTtcclxuXHJcbiAgICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMucHJvY2Vzc2luZyArICcgJyArIHRoaXMuc3luY0xhYmVsLCBjb3VudDogaW5kZXggKyAxLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcclxuICAgIH1cclxuXHJcbiAgICBhd2FpdCBzeW5jLnVwZGF0ZSgpO1xyXG5cclxuICAgIGRhdGFTb3VyY2Uuc291cmNlLmludmFsaWRhdGUodGhpcy5yZXNvdXJjZU5hbWUpO1xyXG5cclxuICAgIHRoaXMucHJvZ3Jlc3Moe21lc3NhZ2U6IHRoaXMuZmluaXNoZWQgKyAnICcgKyB0aGlzLnN5bmNMYWJlbCwgY291bnQ6IG9iamVjdHMubGVuZ3RoLCB0b3RhbDogb2JqZWN0cy5sZW5ndGh9KTtcclxuICB9XHJcbn1cclxuIl19